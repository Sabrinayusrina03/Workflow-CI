name: Build n push image di docker

on:
  push:
    branches:
      - main
    paths:
      - "serving_model/**"
      - "monitoring_metrics/**"
      - "MLProject/**"
      - "Dockerfile"
      - "Dockerfile.serve"
      - "requirements.txt"
      - ".github/workflows/docker-train.yml"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (Emulator untuk platform lain)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx (Untuk build multi-platform)
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Set DOCKER_ENV_DAGSHUB_TOKEN
      - name: Set DagsHub Tracking Token
        run: echo "DOCKER_ENV_DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Diagnose Login Success
        run: |
          docker pull hello-world:latest

          echo "Attempting to push to repository: sabrinayusrinaa/smsml-sabrinayusrina"
          echo "Using username: ${{ secrets.DOCKER_USERNAME }}"

      # Build dan Push
      - name: Build Docker Image (Local Build)
        run: |
          docker build -t sabrinayusrinaa/smsml-sabrinayusrina:latest . --build-arg DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}
          docker tag sabrinayusrinaa/smsml-sabrinayusrina:latest sabrinayusrinaa/smsml-sabrinayusrina:${{ github.sha }}

      - name: Push Docker Image (Explicit Push)
        run: |
          echo "Starting explicit push for latest tag..."
          docker push sabrinayusrinaa/smsml-sabrinayusrina:latest
          echo "Starting explicit push for SHA tag..."
          docker push sabrinayusrinaa/smsml-sabrinayusrina:${{ github.sha }}
